-- changer les categories et article --> codetype à enlever de la class article
-- Un contact est spécifique à un client id par un numerodecontact numcontact= type serial pour eviter les cases vides --> on a au moins un contact à chaque fois/
-- Pour les homonymes de contact on va dire que peu importe car on va demander un cintact à partir du clien
-- conctact est une composition, le contact est un composant du client
-- type serial sur numarticle dans article
-- where nomcontact2 is not null (pour ajouter le contact si le nom de contact est pas nul
-- faire une view pour exploiter les données de commande sur la validitté de la livraison(voir td6 sur les vues)

-- pour insérer des données dans matski_update on utilise : (exemple avec typearticle


/* 
=========================================
=        Update de la BDD matski        =
=========================================
*/
drop schema if exists matski_update cascade;
create schema matski_update;
set schema 'matski_update';



/****************************************
*         Table : _typearticle          *
****************************************/
create table _typearticle(
  codetype      CHAR(1)     not null,
  libelletype   VARCHAR(40) not null,
  constraint PK_TYPEARTICLE primary key (codetype)
);

insert into _typearticle(codetype,libelletype)
  select codetype, libelletype
  from matski.typearticle;

/****************************************
*           Table : _article            *
****************************************/
create table _article(
  numarticle        SERIAL        not null,
  nomarticle        CHAR(20)      not null,
  referenceinterne  CHAR(10)      not null,
  codebarre         CHAR(13)      not null,
  codetype          CHAR(1)       not null,
  coutachat         NUMERIC(10,2) not null,
  prixVente         NUMERIC(10,2) not null,
  constraint PK_ARTICLE primary key (numarticle)
);


ALTER TABLE _article
  ADD CONSTRAINT fk_article_estlie_typearti FOREIGN KEY (codetype)
  REFERENCES matski.TYPEARTICLE (codetype);

insert into _article(numarticle, nomarticle, referenceinterne,codebarre,codetype,coutachat,prixVente)
  select numarticle,nomarticle,referenceinterne,codebarre,codetype,coutachat, prixvente
  from matski.ARTICLE;
  


/****************************************
*           Table : _listeprix          *
****************************************/
CREATE TABLE _listeprix
(
   codeliste     char(1)       NOT NULL,
   libelleliste  varchar(20)   NOT NULL
);

ALTER TABLE _listeprix
   ADD CONSTRAINT pk_listeprix
   PRIMARY KEY (codeliste);
   
insert into _listeprix(codeliste,libelleliste)
  select codeliste,libelleliste
  from matski.LISTEPRIX;


/****************************************
*           Table : _tarifvente         *
****************************************/
CREATE TABLE _tarifvente
(
   numarticle  integer         NOT NULL,
   codeliste   char(1)         NOT NULL,
   prixVente   numeric(10,2)   NOT NULL
);

ALTER TABLE _tarifvente
   ADD CONSTRAINT pk_tarifvente
   PRIMARY KEY (numarticle, codeliste);

ALTER TABLE _tarifvente
  ADD CONSTRAINT fk_tarifvente_tarifvent_article FOREIGN KEY (numarticle)
  REFERENCES matski.article (numarticle) 
  ON UPDATE NO ACTION
  ON DELETE NO ACTION;

ALTER TABLE _tarifvente
  ADD CONSTRAINT fk_tarifven_tarifvent_listepri FOREIGN KEY (codeliste)
  REFERENCES matski.listeprix (codeliste) 
  ON UPDATE NO ACTION
  ON DELETE NO ACTION;
  

INSERT INTO _tarifvente(numarticle,codeliste, prixvente)
  select numarticle, codeliste, prixvente
  from matski.tarifvente;
  
/****************************************
*           Table : _etiquette           *
****************************************/
CREATE TABLE _etiquette
(
   codeEtiquette     char(3)       NOT NULL,
   libelleEtiquette  varchar(70)   NOT NULL,
   codeTypetva       integer       NOT NULL
);

ALTER TABLE _etiquette
   ADD CONSTRAINT pk_etiquette
   PRIMARY KEY (codeetiquette);
   
INSERT INTO _etiquette(codeEtiquette,libelleEtiquette, codeTypetva)
  select codeetiquette, libelleetiquette, codeTypetva
  from matski.etiquette;


  
/****************************************
*           Table : _commande           *
****************************************/
CREATE TABLE _commande
(
   numcommande   serial   NOT NULL,
   numclient     integer  NOT NULL,
   datecommande  date     NOT NULL,
   montantfrais  float    NOT NULL,
   montantht     float    NOT NULL,
   montantttc    float    NOT NULL
);


ALTER TABLE _commande
   ADD CONSTRAINT pk_commande
   PRIMARY KEY (numcommande);

ALTER TABLE _commande
  ADD CONSTRAINT fk_commande_appartient_client FOREIGN KEY (numclient)
  REFERENCES matski.client (numclient);
  

INSERT INTO _commande(numcommande,numclient,datecommande,montantfrais,montantht,montantttc)
  SELECT numcommande,numclient,datecommande,montantfrais,montantht,montantttc
  FROM matski.commande;
  
/****************************************
*           Table : _detailCommande     *
****************************************/
CREATE TABLE _detailCommande
(
  numcommande         int   not null,
  numarticle          int   not null,
  quantiteCommandee   int   not null,
  quantiteLivree      int   not null
 );
 
ALTER TABLE _detailcommande
   ADD CONSTRAINT pk_detailcommande
   PRIMARY KEY (numcommande, numarticle);

ALTER TABLE _detailcommande
  ADD CONSTRAINT fk_detailco_detailcom_article FOREIGN KEY (numarticle)
  REFERENCES matski.article (numarticle);
  
ALTER TABLE _detailcommande
  ADD CONSTRAINT fk_detailco_detailcom_commande FOREIGN KEY (numcommande)
  REFERENCES matski.commande (numcommande);
  

INSERT INTO _detailCommande(numcommande,numarticle,quantiteCommandee,quantiteLivree)
  SELECT numcommande,numarticle,quantiteCommandee,quantiteLivree
  FROM matski.detailcommande;


/*
select setval('matski_update._article_numarticle_seq',
               (select max(numarticle)
               from matski_update._article)
               );
a ajouter quand on aura mis serial dans la classe article pour numarticle */
